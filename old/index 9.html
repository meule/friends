<!DOCTYPE html><html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">
  <meta name="google-site-verification" content="cIuHzF8MJWR_FURv1t2iGCxkHGcAWu-ppDFVFZ1UNnM" />
  <link rel="shortcut icon" href="favicon.ico">
  <script  type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/pace/0.4.15/pace.min.js"> </script>
  <link href="//cdnjs.cloudflare.com/ajax/libs/pace/0.4.10/themes/pace-theme-flat-top.css" rel="stylesheet" />    
  <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/d3/3.3.11/d3.min.js"></script>
  <link href="//netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {   /*font-family: 'PT Sans';*/   background: #ddd;   color: #222; font-size: 14px;}
    text  { }
    p { }
    .labels { fill: #666; font-size: 11px;}
    .light { fill: #aaa;}
    .container {width: 100%; }
    .mainCont {width: 100%;background: #ddd; }
    .pic {
      fill: #bbb;
    }
    .legenda {
      fill: #bbb;
      text-color: #777; font-size: 14px;
    }
    .title {
      fill: #222;
      text-color: #777; font-size: 18px;
    }
    .footer {
        padding: 10px;
      
      background-color: #bbb;
    }
    .smalltext {   /*font-family: 'PT Sans';*/  color: #222; font-size: 12px; }
    .popup {   /*font-family: 'PT Sans';*/  font-size: 12px; }
    .axis {   /*font-family: 'PT Sans';*/  color: #777; fill: #777; font-size: 14px; }
    #sharePic {text-align: center;}
    .modal-dialog {/*width: auto; height: auto; max-height: 96%; max-width: 96%;*/} 
    .mainCont {text-align: center;}
  </style>
  <title>Your Friends — Ages</title>

  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
  <![endif]-->
  </head>

<body>

  <div class="navbar navbar-inverse navbar-static-top" role="navigation">
    <div class="container">
      <div class="navbar-header ">
        <!--button type="button" class="navbar-toggle .navbar-btn"  data-target=".navbar-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar">1</span>
          <span class="icon-bar">2</span>
          <span class="icon-bar">3</span>
        </button-->
        <a class="navbar-brand" >You Are Your Friends. How Old Are They?</a>
      </div>
      <div class="collapse navbar-collapse btn-group">
        <ul id="menu" class="nav navbar-nav navbar-right" role="menu">
          <li id="all" class="active"><a href="#">All Together</a></li>
          <li id="fm"><a href="#" >By Gender</a></li>
          <li id="heart" ><a href="#">Funny Third Option</a></li>
        </ul>
      </div><!--/.nav-collapse -->

    </div>
  </div>

  <div class="container">
    <div id='loginText'><p>Please login to Facebook and let me show your data. It does not hurt you, sure ;-)</p></div>
  <div class="mainCont">
  <div class="alert alert-success alert-dismissable dataPosted" style='display:none'>
    <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
    You are my hero! Thank you -‿-
  </div>    

  <div class="alert alert-success alert-dismissable something" style='display:none'>
    <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
    Something went wrang, sorry -‿-<br /> <a href='mailto:kostia@varik.ru'>Tell me</a>, please.
  </div>    

  <div class="alert alert-success alert-dismissable shared" style='display:none'>
    <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
    Your viz <a id="postedURL">on your timeline</a>. Thank you!
  </div>    

    
     <div id='svg' style='display:none'></div>
     
  </div>
  </div>
      <div class="footer footer-default">
        <div class="container">
        <div class="row">
         <div class="text-left col-xs-6 col-md-4" >

         <div id='fbbutton'>
         <button id='login' class='btn btn-primary btn-left' >Log in with Facebook</button>
          <div id="fb-root"></div>
          
         <!--fb:login-button show-faces="true" width="100%" max-rows="3" ></fb:login-button--></div>
         <div id='logout' style='display:none;'>
          <button id='fblogout' class='btn btn-default btn-left' >Log out of the app</button>
         </div>
         </div>
         <div class="col-xs-6 col-md-4 text-center">
           <button id='share' class='btn btn-primary btn-center share' style='display:none;'>Share on Facebook</button>
         </div>
         <div id='about' class="col-xs-6 col-md-4">
          <p class='smalltext text-left'>
            You are your friends. How old are they? Do you have more younger girls or boys? 
            Who are they? Who are you? Explore yourself through your friends!</p><p class='smalltext text-left'>
            It's beta. Yet only ages are shown. And not optimized for >700 friends yet. But more in 2014. Happy New Year! -‿- </p>
            <p class='smalltext text-right'>
            <a href='http://facebook.com/varik.ru'>Konstantin Varik</a>
          </p>
          </div>
    </div>
    </div>
    </div>
    <!-- Modal -->
  <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
          <h4 class="modal-title" id="myModalLabel">Share Your Viz on your Facebook Timeline*</h4>
        </div>
        <div class="modal-body">
          <p><a href='vritti.ru/friends'>Explore yourself through your friends!</a></p>
          <div id='sharePic'><canvas id='canvas'></canvas></div>
          <p class='smalltext share' style='display:none;'>*When you post your viz to your timeline, I record your anonymized data (only ages and genders, no names). When I have collected enouth data, I'll show average distributions with your own data to give you more insights. </p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">No, thank you</button>
          <button type="button" class="btn btn-info" id='useDataClick'>Just use my anonimized data</button>
          <button type="button" class="btn btn-primary" id='shareClick'>Share on Facebook!</button>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->      

  <img id='imgCanvas' src='' style="display:none"/>

  <script src="//code.jquery.com/jquery-1.10.2.min.js"></script>
  <script src="//netdna.bootstrapcdn.com/bootstrap/3.0.3/js/bootstrap.min.js"></script>
    
  <script>

//Bootstap events
$(document).ready(function() {
    $('#menu li').click(function() {
        $('#menu li').addClass('active').not(this).removeClass('active');
    });
    $('#login').click(function(){
      fbLogin(function(response){ console.log(response) })
    });
    $('#all').click(function(){
      showAll();
    });
    $('#fm').click(function(){
      showFM();
    });
    $('#heart').click(function(){
      showHeart();
    });
    $('#share').click(function(){
      post2fbModal();
      //fbPostPerm();
    });
    $('#useDataClick').click(function(){
      postData();
      $('#myModal').modal('hide');
      $(".dataPosted").alert();
      d4.show('.dataPosted');

    });
    $('#fblogout').click(function(){
      FB.logout(function(response) {
        console.log(response);
        d4.show('#fbbutton');
        d4.hide('#logout');
        d4.hide('#share');
        already=false;
        svg.transition().attr('height',0).duration(2000).remove();
        svg=null;
        FB.api('/me/permissions', 'delete', function(response) {
            console.log(response); // true
        });
      });
    });
    });

var d4={

  scroll2: function(offS,dura,offSplus){
    target_offset = $(offS).offset(),
    target_top = target_offset.top + (offSplus || 0);
    $('html, body').animate({
        scrollTop: target_top
    }, dura);
  },

  up: function (t){ t.parentNode.appendChild(t) },

  text2words: function(ttt){
    return csvData[i].text
      .replace( /(?:\bhttps?:\/\/|\bwww\.|\[url)\S+\s*/g, '' )
      .replace(/[,.:?!()<>'"@;/-]/g,' ')
      .replace(/\s{2,}/g, ' ')
      .replace(/^\s/,'').replace(/\s$/,'')
      .split(' ');
  },


  OpenInNewTab : function(url)
  {
    //console.log(url);
    var win=window.open(url, '_blank');
    win.focus();
  },

  show : function (cssName) { 
    t=d3.selectAll(cssName); 
    t.attr('display') ? t.attr('display',null) :''
    return t.style('display',null); 
  },

  hide: function (cssName) { 
    return d3.selectAll(cssName).style('display','none'); 
  },

  visible: function(cssName) {
    return ((Math.round((+d3.select(cssName).style('fill-opacity'))*100)!=0)&&(d3.selectAll(cssName).style('display')!='none'))
  },

  showOp: function(cssName,duration) {
    return d3.selectAll(cssName).transition().style("fill-opacity",1.0).duration(duration ? duration : dur);
  },

  hideOp: function(cssName,duration) {
    return d3.selectAll(cssName).transition().style("fill-opacity",0).duration(duration ? duration : dur);
  },

  rect: function (d3element,x,y,width,height,id,fill,stroke,strokeWidth,nonVisible,cssClass) {
    return d3element.append('rect')
      .attr('x',x)
      .attr('y',y)
      .attr('width',width)
      .attr('height',height)
      .attr('id',id ? id : null)
      .style('fill',fill ? fill : 'none')
      .style('stroke',stroke ? stroke : 'none')
      .style('stroke-width',strokeWidth ? strokeWidth : 0)
      .style('display',nonVisible ? 'none' : null)
      .attr('class',cssClass ? cssClass : null)
  },

  text: function(d3element, text, x, y, cssClass, id, align,anima) {
    textEl=d3element.append('text')
      .attr('id',id)
      .attr('class',cssClass)
          .style('text-anchor',align ? (align=='right'||'end' ? 'end' : (align=='left' ? 'begin' : 'middle')) : '')
          .style('text-align',align ? align : 'begin')
          .text(text)
          .attr('y',y)
          .attr('x',x);   
      if (anima) 
        textEl.style('fill-opacity',0)
          .transition()
          .style('fill-opacity',1)
          .duration(500);
      return textEl;
  },
  wWidth: function () {
    var w = window,
        d = document,
        e = d.documentElement,
        g = d.getElementsByTagName('body')[0];
        return w.innerWidth || e.clientWidth || g.clientWidth
  },

  elWidth: function (element) {
    return parseInt(window.getComputedStyle(element,null).getPropertyValue("width"))
  },
  wHeight: function () {
    var w = window,
        d = document,
        e = d.documentElement,
        g = d.getElementsByTagName('body')[0];
        return w.innerHeight|| e.clientHeight|| g.clientHeight;
  },
  svg2canvas: function(svgID, canvasID,cwidth,cheight){
    // convert base64 to raw binary data held in a string
    // doesn't handle URLEncoded DataURIs
    //console.log($("#"+svgID),$("#"+svgID).html(), canvasID,cwidth,cheight);
    canvg(canvasID, $("#"+svgID).html(),{
      'scaleWidth':cwidth,
      'scaleHeight':cheight,
      'useCORS':true,
      'ignoreMouse': true, 
      'ignoreAnimation': true
    });
    // the canvas calls to output a png
    canv=document.getElementById(canvasID);
    canv.style.width=(canv.width=cwidth)+'px';
    canv.style.height=(canv.height=cheight)+'px';
    //canv.style=null;
    return canv;
  },

  canvas2png: function(canvas){

    dataURI = canvas.toDataURL("image/png");

      var byteString = atob(dataURI.split(',')[1]);
      var ab = new ArrayBuffer(byteString.length);
      var ia = new Uint8Array(ab);
      for (var i = 0; i < byteString.length; i++) {
          ia[i] = byteString.charCodeAt(i);
      }
      return new Blob([ab], {
          type: 'image/png'
      });

  },
  loadJS: function(scripts,callback1){
    i=0;
    scripts.forEach(function(d){
      jsURL=d;
      //console.log(d);
      (function(d){
           var js, id = i++, ref = d.getElementsByTagName('script')[0];
           if (d.getElementById(id)) {return;}
           js = d.createElement('script'); js.id = id; js.async = true;
           js.src = jsURL;
           ref.parentNode.insertBefore(js, ref);
           //console.log(js);
           js.onload=callback1;
        }(document));
    })
  },
  ImgToBase64: function(url, callback, outputFormat){
        //http://stackoverflow.com/questions/6150289/how-to-convert-image-into-base64-string-using-javascript
        // 2DO for IE: http://stackoverflow.com/questions/18112047/canvas-todataurl-working-in-all-browsers-except-ie10

        var canvas = document.createElement('CANVAS');
        var ctx = canvas.getContext('2d');
        var img = new Image;
        img.crossOrigin = 'Anonymous';
        img.onload = function(){
            canvas.height = img.height;
            canvas.width = img.width;
            ctx.drawImage(img,0,0);
            var dataURL = canvas.toDataURL(outputFormat || 'image/png');
            callback.call(this, dataURL);
            // Clean up
            canvas = null; 
        };
        img.src = url;
    }
  }
  if (!Array.prototype.last){
    Array.prototype.last = function(){
      return this[this.length - 1];
    };
  };

var svg, blob;
  //heart path is from http://thenounproject.com/term/heart/187/
  var heartString='M49.999,91.46c3.944-3.943,26.458-26.47,40.533-40.543c12.61-12.611,12.341-30.992,0.876-42.395C79.943-2.884,61.404-2.834,49.999,8.632C38.595-2.834,20.056-2.884,8.591,8.522C-2.874,19.925-3.142,38.306,9.467,50.917C23.541,64.99,46.058,87.517,49.999,91.46z';

  var modeKeys={agesAll:{kMode:'ages',kGender:'All'},agesFM:{kMode:'ages',kGender:'FM'},boxAll:{kMode:'box',kGender:'All'},boxFM:{kMode:'box',kGender:'FM'},heart:{kMode:'heart'}};
  var modes=['boxAll','boxFM','agesAll','agesFM','heart'], curMode='no';
  var today=new Date();

  var lowPercent, highPercent, percent, minFriendsNorm=200, minAgesNorm=25;

  var already=false, isRandomCalc=false, uploadGranted=false, isLowInterval=false, isHighInterval=false, isFolded=false, isChangePic=true, isDataSent=false, isStatShow=false, lastStrNum=0;
  var size={ages:{},box:{}};
  var minWidth=960
      width=minWidth, 
      heartWidth=300,
      heightH=500,
      widthH=500,
      shareScale=2,
      scale={},
      sSize=20, lSize=50, delta=1, tMargin=5, tHeight=17, tHeightAxis=15;
      pWidth=220, pHeight=sSize*2, labelWidth=70, lowHighMargin=10, sameAgeTextMargin=110,
      height=720, margin={x:{},y:(sSize+delta)*2}, margins=20,
      dur=1000;
  var you, friends, me;
  var num={}, minAge={}, maxAge={}, ages=[], meY, age={}, curSame=[];
  var friends=[], fr=[], frM=[], frF=[], byAge={}, byAgeM={}, byAgeF={}, fStat=[];
  
  var authToken;
  var shareString="Explore yourself through your friends! http://vritti.ru/friends",
      fbPostedURL='https://www.facebook.com/photo.php?fbid=',
      statURL='./',
      fbPicURL="//graph.facebook.com/";

var modeTexts=
  {
    boxAll:'So, you have {1} friends on Facebook',
    boxFM: 'They are {1} ({2}%) girls and {3} ({4}%) boys',
    agesAll:'{1}% of your friends are younger and {2}% are older than you',
    agesFM:'You have {1}more younger {2} ({3}%) than younger {4} ({5}%)',
    heart:'You are your friends. Love them! -‿-',
    parse:function(key){
      for(i=1;i<arguments.length;i++) {
        this[key]=this[key].replace('{'+i+'}',''+arguments[i]);
      }
    },
    init:function(){
      this.parse('boxAll',num.all-1);
      this.parse('boxFM',num.f,num.fP,num.m,num.mP);
      this.parse('agesAll',num.younger.allP,num.older.allP);
      fmDelta=num.younger.mP-num.younger.fP;
      this.parse('agesFM',Math.abs(fmDelta)>15 ? 'much ' : (Math.abs(fmDelta)<5 ? 'a little bit ' : ''),fmDelta>0 ? 'boys' : 'girls',fmDelta>0 ? num.younger.mP : num.younger.fP,fmDelta<0 ? 'boys' : 'girls',fmDelta<0 ? num.younger.mP : num.younger.fP);
    }
  };

function fbLogin(){
    if (!uploadGranted)
      FB.login(function(response) {
          }, {scope: 'user_about_me,user_birthday,friends_about_me,friends_birthday'});
}

function fbPostPerm(){
    FB.login(function(response) {
          console.log(response);
          if (response.status==='connected') post2fb()
            else {
              $(".something").alert();
              d4.show('.something');
            }
        }, {scope: 'photo_upload'});
}

window.fbAsyncInit = function() {
    FB.init({
        appId    : '130978340377178',
        status    : false, // check login status
        cookie    : false, // enable cookies to allow the server to access the session
        xfbml    : false, // parse XFBML
        oauth   :true
    });
    FB.Event.subscribe('auth.authResponseChange', function(response) {   
        console.log(response,response.status);
         if (response.status === 'connected') {
            authToken=response.authResponse.accessToken;
            if (!already) {
               you={}, friends=[], me={};
               num={}, minAge={}, maxAge={}, num.max={}, ages=[], meY=0;;
               fr=[], frM=[], frF=[], byAge={}, byAgeM={}, byAgeF={};
              
              d4.hide('#fbbutton');
              d4.show('#logout');
              getData();
            }
         } else if (response.status === 'not_authorized') {
            fbLogin();
         } else {
            fbLogin();
         }
    });
    };

(function(d){  var js, id = 'facebook-jssdk', ref = d.getElementsByTagName('script')[0];
     if (d.getElementById(id)) {return;}
     js = d.createElement('script'); js.id = id; js.async = true;
     js.src = "//connect.facebook.net/en_US/all.js";
     ref.parentNode.insertBefore(js, ref);
     //console.log(js);
      }(document));

function getData() {

    FB.api({ method: 'fql.query', query: 'SELECT user_about_me,user_birthday,friends_about_me,friends_birthday,photo_upload FROM  permissions WHERE uid=me()' }, function(resp) {   
    if (resp[0]['photo_upload']==="1") uploadGranted=true;     
    for(var key in resp[0]) {        
        if(resp[0][key] === "1")        
            console.log(key+' is granted');        
        else        
            console.log(key+' is not granted');        
    }        
    });   
    
    FB.api('/me?fields=id,name,birthday,gender', function(response) { you=response;  });
    FB.api('/me/friends?fields=id,name,birthday,gender', function(response) { 
      friends=response.data; 
      if (friends)
        if (friends.length>0) {
          already=true;
          fshow(); 
        }
      
    });
}
    
function showStat(strNum) {
  if (!strNum&&strNum!=0) strNum=lastStrNum;
  fr=[], you={}, friends=[], me={};
  num={}, minAge={}, maxAge={}, num.max={}, ages=[], meY=0;;
  fr=[], frM=[], frF=[], byAge={}, byAgeM={}, byAgeF={};
  percent=1;
  if (svg) svg.remove();

  function showS(){
    var fff2 = eval("(" + fStat[strNum] + ")");
    var fff=fff2["Friends"];
    console.log('img: '+fff2['Img']);
    for (i=0;i<fff.length;i++) {
      fff[i].id=i;
      fff[i].name='Innokentiy';
      fff[i].birthday=fff[i].bd;
      fff[i].gender=fff[i].g;
      if (fff[i].me) you=fff[i]
        else friends.push(fff[i]);
      //console.log(fff[i]);
    }
    fshow(); 
  }
  if (fStat.length==0) 
    d3.text('../friends2.json',function(error,data){
      fStat=data.split('\n');
      isStatShow=true;
      showS();
    })  
  else showS();
  lastStrNum=strNum+1;
}

function calcLowHigh(lowP,highP){
  //debugger;
  age.low=age.min.all;
  age.high=age.max.all

  //calculate intervals' percents
    if (lowP) {
      highPercent=highP;
      lowPercent=lowP;
    } else {
      deltaH=age.max.all-(me.fAge ? me.fAge : (age.max.all-age.min.all)/2);
      deltaL=-age.min.all+(me.fAge ? me.fAge : (age.max.all-age.min.all)/2);
      highPercent=deltaH/(deltaH+deltaL);
      lowPercent=deltaL/(deltaH+deltaL);
      
      highPercent=percent*highPercent;
      lowPercent=percent*lowPercent;
    }

  //calculate intervals' age and size
    hAge=age.max.all+(age.max.all-age.min.all)%scale.ages.y;
    for(num.high=0, lastNum=0; num.high+lastNum<Math.floor((num.folded.max.all/scale.ages.x||num.max.all)*highPercent);hAge=hAge-scale.ages.y) {
      num.high+=lastNum;
      for(lastNum=0;Math.floor((fr[fr.length-num.high-lastNum-1].fAge-age.min.all)/scale.ages.y)==Math.floor((hAge-age.min.all)/scale.ages.y);lastNum++);

    };
    if (fr[num.toomuch-num.high]) age.high=fr[num.toomuch-num.high].fAge
      else age.high=fr[num.toomuch-num.high-1].fAge;

    lAge=age.min.all+scale.ages.y;
    for(num.low=0, lastNum=0; num.low+lastNum<Math.floor((num.folded.max.all||num.max.all)*lowPercent);lAge=lAge+scale.ages.y) {
      num.low+=lastNum;
      for(lastNum=0;fr[num.low+lastNum].fAge<lAge;lastNum++);
    };
    num.low=num.low||1;
    age.low=fr[num.low-1] ? fr[num.low-1].fAge : fr[0].fAge;

    //debugger;

  //calculate high and low intervals and make distribution with them (ageY, ageNum)
    for (i=0, ii={male:0,female:0}, iii={all:0,male:0,female:0};i<fr.length;i++) {
        fr[i].ages.X=fr[i].ages.XFull;
        fr[i].ages.XFM=fr[i].ages.XFMFull;
        sex=fr[i].gender;
        if (i<num.low) {
            fr[i].ages.Y=0; 
            fr[i].first=true;
            fr[i].ages.X=i; 
            if (sex) fr[i].ages.XFM=ii[sex]++;
        } else {
            fr[i].last=fr[i].first=false;
            fr[i].ages.Y=fr[i].ages.YFull-Math.floor((age.low-age.min.all+1)/scale.ages.y)+1;
            if (fr[i].fAge>=age.high) {
                fr[i].ages.Y=Math.floor((age.high-age.low-1)/scale.ages.y)+1;
                fr[i].last=true;
                fr[i].ages.X=iii.all++;
                if (sex) fr[i].ages.XFM=iii[sex]++;
            }
        }
        fr[i].ages.YFM=fr[i].ages.Y;
    }
    if (age.low!=age.min.all) isLowInterval=true; 
    if (age.high!=age.max.all) isHighInterval=true;
    //debugger;
}

function foldByX(key){
  //debugger;
  for (i=0, same={all:[0],female:[0],male:[0]};i<fr.length;i++) {
    fr[i][key].X=Math.floor(fr[i][key].X/scale[key].x);
    if ((fr[i][key].X!=fr[same.all[0]][key].X)||(fr[i][key].Y!=fr[same.all[0]][key].Y)||(!i)) {
    if (i) fr[same.all.last()][key].onTopAll=true;
      same.all=[];
    }
    same.all.push(i);
    fr[i][key].sameAll=same.all;
    if (sex=fr[i].gender) {
      fr[i][key].XFM=Math.floor(fr[i][key].XFM/scale[key].x);
      if ((fr[i][key].XFM!=fr[same[sex][0]][key].XFM)||(fr[i][key].YFM!=fr[same[sex][0]][key].YFM)) {
        fr[same[sex].last()][key].onTopFM=true;
        same[sex]=[];
      }
      if (i) same[sex].push(i)
      fr[i][key].sameFM=same[sex];
    }
  }
}        

function dataInit(){
    num={all:0,dates:0,ages:0,toomuch:0,gender:0,m:0,f:0,younger:{all:0,f:0,m:0},older:{all:0,f:0,m:0},low:1,high:1,max:{all:0,f:0,m:0},
      noAge:{all:0,f:0,m:0},me:{all:0,f:0,m:0},ageGroups:0,folded:{max:{all:0,f:0,m:0}}};
      age={min:{all:0,f:0,m:0},max:{all:0,f:0,m:0}};
      scale={ages:{x:1,y:1},box:{x:1}};
      scale.ages.y=1, scale.ages.x=1;
      isLowInterval=false, isHighInterval=false, isFolded=false;

      size.ages.x=Math.floor((d4.wWidth()-labelWidth-margins*2-sameAgeTextMargin)/(sSize+delta));
      size.ages.y=Math.floor((d4.wHeight()-lowHighMargin*2)/(sSize+delta))-2;

      you.itsme=true;
      if (you.birthday) friends.push(you);

      num.all=friends.length;

    //calculate ages from birthdays
      friends.forEach(function(d){
        d.ages={};
        d.box={};
        if (sex=d.gender) {
            num.gender++;
            num[sex[0]]++;
        }
        if (d.birthday) {
            num.dates++;
            if (d.date=d3.time.format('%m/%d/%Y').parse(d.birthday)) {
                num.ages++;
                if ((ageCur=(today - d.date)/31557600000)<90) {
                    num.toomuch++;
                    d.age=ageCur;
                    d.fAge=Math.floor(d.age);
                    fr.push(d);
                    if (!byAge[Math.floor(ageCur)]) byAge[Math.floor(ageCur)]=[];
                    byAge[Math.floor(ageCur)].push(d);
                }
            }
        }
        if (+d.id===+you.id) me=d; 
      });

    fr.sort(function(a,b){if (b.age) {return a.age-b.age} else return false; });
      age.min.all=Math.floor(fr[0].age);
      age.max.all=Math.floor(fr[fr.length-1].age);
    
    // calculate full distribution (ageY, ageNum)
      for (i=0, ii={all:0,male:0,female:0};i<fr.length;i++) { 
          fr[i].ages.YFull=fr[i].fAge-age.min.all;
          if (sex=fr[i].gender) fr[i].ages.YFMFull=fr[i].ages.YFull;
          if (fr[i].fAge > (prevAge = fr[i&&(i-1)].fAge)) ii={all:0,male:0,female:0};
          fr[i].ages.XFull=ii.all++;
          num.max.all=Math.max(ii.all,num.max.all);
          if (fr[i].fAge==me.fAge) num[curKey='me'].all++;
          if (fr[i].age<me.age) curKey='younger';
          if (fr[i].age>me.age) curKey='older';
          num[curKey].all++;
          if (sex) {
            num[curKey][sex[0]]++;
            if (fr[i].fAge==me.fAge) num.me[sex[0]]++;
            fr[i].ages.XFMFull=ii[sex]++;
            num.max[sex[0]]=Math.max(ii[sex],num.max[sex[0]]);
            
          }
      }

    // calculate and iterate low and high interval's percents
      if ((age.max.all-age.min.all+1)>=size.ages.y) percent=0.5 
        else percent=0;
      calcLowHigh();
      if (age.high-age.low+1>=size.ages.y) {
        percent=1;
        calcLowHigh();
      }
      /*
      if (age.high-age.low+1>=size.ages.y) {
        calcLowHigh((lowPercent>highPercent) ? 1 : lowPercent*(1/highPercent), (lowPercent<highPercent) ? 1 : highPercent*(1/lowPercent));
      }
      */
      if (age.high-age.low+1>=size.ages.y)
        scale.ages.y=Math.floor((age.high-age.low+1)/size.ages.y)+1;
      
      if (num.ages<100 && (age.high-age.low)/num.max.all>3)  
        scale.ages.y=Math.max(scale.ages.y,Math.floor(100/num.ages)+1);

      //console.log(scale.ages.y);

    // collapse ranges by scale.ages.y
      if (scale.ages.y>1) {
        for (i=0, ii={all:0,male:0,female:0}, lastAge={all:age.min.all,male:age.min.all,female:age.min.all}; i<fr.length; i++) {          
          if (fr[i].fAge-lastAge.all>1) ii.all=-1;
          if (modResult=(fr[i].ages.YFull) % scale.ages.y) ii.all++
            else ii.all=fr[i].ages.XFull;
          fr[i].ages.X=ii.all;
          fr[i].ages.Y=fr[i].ages.YFull-modResult;
          lastAge.all=fr[i].fAge;
          num.folded.max.all=Math.max(num.folded.max.all,fr[i].ages.X+1);
          if (sex=fr[i].gender) {
            if (fr[i].fAge-lastAge[sex]>1) ii[sex]=-1;
            if (modResult=(fr[i].ages.YFMFull) % scale.ages.y) ii[sex]++
              else ii[sex]=fr[i].ages.XFMFull;
            fr[i].ages.XFM=ii[sex];
            fr[i].ages.YFM=fr[i].ages.YFMFull-modResult;
            lastAge[sex]=fr[i].fAge;       
            num.folded.max[sex[0]]=Math.max(num.folded.max[sex[0]],fr[i].ages.XFM+1);     
          }
        }
        for (i=0; i<fr.length; i++) {
          fr[i].ages.Y=(fr[i].ages.YFull=fr[i].ages.Y/scale.ages.y);
          fr[i].ages.YFMFull=fr[i].ages.YFM=fr[i].ages.Y;
          fr[i].ages.XFull=fr[i].ages.X;
          fr[i].ages.XFMFull=fr[i].ages.XFM;
        }
        age.low=age.min.all;
        age.high=age.max.all;
        isLowInterval=false, isHighInterval=false;
      }

    // calculate and iterate collapsed low and high interval's percents
      if ((Math.floor((age.max.all-age.min.all-1)/scale.ages.y)+2)>=size.ages.y) {
        percent=0.5;
        calcLowHigh();
      } else percent=0;

      if ((Math.floor((age.high-age.low-1)/scale.ages.y)+2)>=size.ages.y) {
        percent=1;
        calcLowHigh();
      }
      /*
      if (age.high-age.low+(scale.ages.y>1 ? 2 : 1)>=size.ages.y) {
        calcLowHigh((lowPercent>highPercent) ? 1 : lowPercent*(1/highPercent), (lowPercent<highPercent) ? 1 : highPercent*(1/lowPercent));
      }
      */

    // data for Y-axis
      //  age.low=(age.low+scale.ages.y-(age.low-age.min.all+1)%scale.ages.y);
      for (i=age.low-(age.low-age.min.all)%scale.ages.y;i<=age.high;i=scale.ages.y+i) { 
        ages.push({n:num.ageGroups++,text:( ''+(i)+ (scale.ages.y==1 ? '' : '...'+(i+scale.ages.y-1)) )});
        if (me.fAge-i<scale.ages.y && me.fAge-i>=0) ages[ages.length-1].me=true;
        }

        if (isLowInterval) {
          ages[0].low=true;
          ages[0].text=age.min.all+'...'+age.low;
        }
        if (isHighInterval) {
          ages[ages.length-1].high=true;
          ages[ages.length-1].text=age.high+'...'+age.max.all;
        }

        ages.push({n:num.ageGroups,text:''})
        ages.push({n:num.ageGroups+1,text:'hidden',noAge:true})

    //calculate no age friends
      maxNoAge=-1+(Math.floor((size.ages.x*(Math.floor(((num.folded.max.m||num.max.m)+(num.folded.max.f||num.max.f))/size.ages.x)+1)-((num.folded.max.m||num.max.m)+(num.folded.max.f||num.max.f)))/2))+Math.min((num.folded.max.m||num.max.m),(num.folded.max.f||num.max.f));
      for (i=0, ii={all:0,male:0,female:0}, noAgeNum={all:0,male:0,female:0};i<friends.length;i++) {
          if (!friends[i].age) {
              num.noAge.all++;
              if (ii.all>=(num.folded.max.all||num.max.all)) {
                ii.all=0;
                noAgeNum.all++;
              }  
              friends[i].ages.Y=num.ageGroups+1+noAgeNum.all;
              friends[i].ages.X=ii.all++;
              if (sex=friends[i].gender) {
                num.noAge[sex[0]]++;
                
                //console.log(maxNoAge);
                if (ii[sex]>=maxNoAge) {
                  ii[sex]=0;
                  noAgeNum[sex]++;
                }  
                friends[i].ages.YFM=num.ageGroups+1+noAgeNum[sex];
                friends[i].ages.XFM=ii[sex]++;
              }
              friends[i].last=true;
              fr.push(friends[i]);
          }
      }

    // fold horizontally
      if ((num.folded.max.m||num.max.m)+(num.folded.max.f||num.max.f)>size.ages.x) {
        scale.ages.x=Math.floor(((num.folded.max.m||num.max.m)+(num.folded.max.f||num.max.f))/size.ages.x)+1;
          foldByX('ages');
      }    

    // SIZES
      height=(num.ageGroups+Math.max(noAgeNum.all,noAgeNum.male,noAgeNum.female)+2)*(sSize+delta)+lowHighMargin*2;
      width=Math.max(d4.wWidth()-2*margins);
      margin.x.agesAll=Math.floor((width-(((Math.floor(num.folded.max.all/scale.ages.x||num.max.f))+1)*(sSize+delta)+labelWidth+sameAgeTextMargin))/2);
      if (margin.x.agesAll<0) margin.x.agesAll=0;

      margin.x.agesFM=Math.floor((width-((Math.floor(num.folded.max.f/scale.ages.x||num.max.f)+Math.floor(num.folded.max.m/scale.ages.x||num.max.m)+4)*(sSize+delta)+labelWidth+sameAgeTextMargin*2))/2)+sameAgeTextMargin;
      if (margin.x.agesFM<0) margin.x.agesFM=0;

      //TODO правильно рассчитать размеры box
      size.box.max={x:Math.floor(width/(sSize+delta))-5, y:Math.floor(height/(sSize+delta))-6};
      scale.box.x=Math.floor(num.all/((size.box.max.x)*(size.box.max.y)))+1;
      var prop=Math.sqrt((num.all/scale.box.x)/(size.box.max.x*size.box.max.y));      
      console.log(prop);
      size.box.y=Math.floor(size.box.max.y*prop);
      if (size.box.y>size.box.max.y) size.box.y=size.box.max.y;
      size.box.x=Math.floor(num.all/size.box.y);

    // calculate BOX mode
      size.box.fm=Math.floor(size.box.x/2)-1;
      for (i=0, iM=0, iF=0;i<fr.length;i++) {
        fr[i].box={Y:Math.floor(i/size.box.x),X:i%size.box.x};
        if (sex=fr[i].gender) {
          if (sex=='female') {
            fr[i].box.YFM=Math.floor(iF/size.box.fm);
            fr[i].box.XFM=(iF++) % size.box.fm; 
          } else {
            fr[i].box.YFM=Math.floor(iM/size.box.fm);
            fr[i].box.XFM=(iM++) % size.box.fm; 
          }         
        }
      }
      if (scale.box.x>1) foldByX('box');
      margin.x.box=Math.floor((width-(Math.floor(size.box.x/scale.box.x)+1)*(sSize+delta))/2);

    //calculate x-y
      fr.forEach(function(d){
        d.x={
          agesAll: d.ages.X*(sSize+delta)+labelWidth+margin.x.agesAll,
          agesFM: d.gender ? ( (d.gender=='female') ? (margin.x.agesFM+(Math.floor(num.folded.max.f/scale.ages.x||num.max.f)-d.ages.XFM)*(sSize+delta)) : ((Math.floor(num.folded.max.f/scale.ages.x||num.max.f)+d.ages.XFM)*(sSize+delta)+labelWidth+margin.x.agesFM) ) : -sSize,
          boxAll: margin.x.box+(d.box.X)*(sSize+delta),
          boxFM: d.gender ? ( (d.gender=='female') ? (margin.x.box+(size.box.fm/scale.box.x-1-d.box.XFM)*(sSize+delta)) : ( margin.x.box+(size.box.fm/scale.box.x+d.box.XFM+2)*(sSize+delta) ) ) : -sSize
        };
        if (d.first) margs=0;
        else if (d.last) margs=lowHighMargin*isLowInterval+lowHighMargin*isHighInterval
        else margs=lowHighMargin*isLowInterval;
        d.y={
          agesAll: margin.y+d.ages.Y*(sSize+delta)+margs,
          agesFM: margin.y + (d.gender ? d.ages.YFM*(sSize+delta)+margs : -sSize), 
          boxAll: margin.y+(d.box.Y)*(sSize+delta),
          boxFM: margin.y+ (d.gender ? (d.box.YFM)*(sSize+delta) : 0)
        }
      })    

    //calculate percents
      num.mP=Math.round(100*num.m/(num.all));
      num.fP=Math.round(100*num.f/(num.all));

      num.noAgeP=Math.round(100*num.noAge.all/num.all);
      num.noAge.mP=Math.round(100*num.noAge.m/(num.noAge.m+num.m));
      num.noAge.fP=Math.round(100*num.noAge.f/(num.noAge.f+num.f));

      num.younger.allP=Math.round(100*num.younger.all/(num.younger.all+num.older.all));
      num.younger.mP=Math.round(100*num.younger.m/(num.m-num.noAge.m));
      num.younger.fP=Math.round(100*num.younger.f/(num.f-num.noAge.f));
      num.older.allP=Math.round(100*num.older.all/(num.younger.all+num.older.all));
      num.older.mP=Math.round(100*num.older.m/(num.m-num.noAge.m));
      num.older.fP=Math.round(100*num.older.f/(num.f-num.noAge.f));

      modeTexts.init();
}

function svgInit(){
    d3.selectAll('canvas').attr('width',width/shareScale).attr('height',height/shareScale);

    svg=d3.select('#svg').append('svg')
      .attr('width',width+'px').attr('height',height+'px')
      .attr('id','friendsSVG');

    d3.ns.prefix.xmlns = 'http://www.w3.org/2000/svg';

    svg.attr('xmlns:xlink','http://www.w3.org/1999/xlink');

    d4.show('#svg');
    d4.hide('#loginText');
    d4.rect(svg,0,0,width,height,'back','#fff')
      .attr('fill-opacity',0)
      .on('click',function(){
        d3.selectAll('.popup').remove(); })
      .on('mouseover',function(){
        d3.selectAll('.popup').remove(); });

    if (you.fAge) {
        meY=(you.ages.Y)*(sSize+delta)-1+lowHighMargin*isLowInterval;
        d4.rect(svg,0,margin.y+meY,width,sSize+delta+1,'yourAge','#ccc').style('fill-opacity',0).transition().style('fill-opacity',1).duration(dur);
    }  

    svg.append('g').attr('id','axis');

    imgrs=svg.append('g').attr('id','pics').selectAll('g').data(fr).enter().append('g');
    imgrs.append('rect')
        .attr('class','pic')
        .attr('width',sSize).attr('height',sSize);
    imgrs.append('svg:image')
        .attr('id',function(d){return d.id})
        .style('opacity',1)
        .attr('class','pic')
        .attr('width',sSize).attr('height',sSize)
        //.attr('xlink:href',function(d){ return "http://graph.facebook.com/"+d.id+"/picture"})
        .on('mouseover',function(d){popup(d,this)})
        .each(function(d){
          var thisImg=this;
          //console.log(fbPicURL+d.id+"/picture?width="+sSize*2+"&height="+sSize*2);
          d4.ImgToBase64(isStatShow ? './block.png' : fbPicURL+d.id+"/picture?width="+sSize*4+"&height="+sSize*4, function(base64Img){
              //console.log(base64Img);
              d.picSrc=base64Img;
              d3.select(thisImg).attr('xlink:href',base64Img);
              d3.select(thisImg.parentNode).select('rect').remove();
          });                
         });
}

function fshow() {
    dataInit();
    svgInit();
    d4.scroll2('.mainCont',dur,-margins/2);
    
    d4.show('.share');
    showAll();
    setTimeout(changePic,100);

    /*! Collapsible.js 1.0.0
      * https://github.com/jordnkr/collapsible
      *
      * Copyright 2013, Jordan Ruedy
      * This content is released under the MIT license
      * http://opensource.org/licenses/MIT
      */
      (function(e,t){e.fn.collapsible=function(t,n){var r={accordionUpSpeed:400,accordionDownSpeed:400,collapseSpeed:400,contentOpen:0,arrowRclass:"arrow-r",arrowDclass:"arrow-d",animate:true};if(typeof t==="object"){var i=e.extend(r,t)}else{var i=e.extend(r,n)}return this.each(function(){if(i.animate===false){i.accordionUpSpeed=0;i.accordionDownSpeed=0;i.collapseSpeed=0}var n=e(this).children(":even");var r=e(this).children(":odd");var s="accordion-active";switch(t){case"accordion-open":case"accordion":if(t==="accordion-open"){e(n[i.contentOpen]).children(":first-child").toggleClass(i.arrowRclass+" "+i.arrowDclass);e(r[i.contentOpen]).show().addClass(s)}e(n).click(function(){if(e(this).next().attr("class")===s){e(this).next().slideUp(i.accordionUpSpeed).removeClass(s);e(this).children(":first-child").toggleClass(i.arrowRclass+" "+i.arrowDclass)}else{e(n).children().removeClass(i.arrowDclass).addClass(i.arrowRclass);e(r).slideUp(i.accordionUpSpeed).removeClass(s);e(this).next().slideDown(i.accordionDownSpeed).addClass(s);e(this).children(":first-child").toggleClass(i.arrowRclass+" "+i.arrowDclass)}});break;case"default-open":default:if(t==="default-open"){e(n[i.contentOpen]).children(":first-child").toggleClass(i.arrowRclass+" "+i.arrowDclass);e(r[i.contentOpen]).show()}e(n).click(function(){e(this).children(":first-child").toggleClass(i.arrowRclass+" "+i.arrowDclass);e(this).next().slideToggle(i.collapseSpeed)});break}})}})(jQuery)
    d4.loadJS(["//cdnjs.cloudflare.com/ajax/libs/raphael/2.1.2/raphael-min.js"],function(){
      isRandomCalc=randomCalc();
    });
    d4.loadJS(["//canvg.googlecode.com/svn/trunk/rgbcolor.js","//canvg.googlecode.com/svn/trunk/StackBlur.js","//canvg.googlecode.com/svn/trunk/canvg.js"]);
    postDataAges('1');
} 

function scaleLegenda(){
  curScale=scale[modeKeys[curMode].kMode].x;
  if (curScale>1) {
    //console.log(curScale);
    for(i=0;i<curScale;i++) svg.append('svg:image')
        .attr('class',curMode)
        .attr('width',sSize).attr('height',sSize)
        .attr('xlink:href',"man.jpg")
        .attr('x',width-tMargin*2-(i+1)*(sSize+delta))
        .attr('y',0);
    svg.append('rect')
        .attr('class','legenda '+curMode)
        .attr('width',sSize).attr('height',sSize)
        .attr('x',width-tMargin*2-(i+2)*(sSize+delta))
        .attr('y',0);
    svg.append('text').attr('class','legenda '+curMode)
        .style('text-anchor','middle')
        .style('font-weight','bold')
        .text('=')
        .attr('x',width-tMargin*2-(i+0.5)*(sSize+delta))
        .attr('y',tHeightAxis);
  }
}

function popup(d,t){
    ind=fr.indexOf(d)
    if (modeKeys[curMode].kGender) curSame=fr[ind][modeKeys[curMode].kMode]['same'+modeKeys[curMode].kGender];
    if (!(curSame))
      curSame=[ind];

    xx=1*d3.select(t).attr('x'); 
    yy=1*d3.select(t).attr('y');

    svg.append('rect').attr('class','popup').attr('stroke-width',0)
        .attr('y',yy-delta*2).attr('x',xx-delta*2).attr('height',0).attr('width',0)
        .attr('fill','#444').attr('fill-opacity',0.9)
        .transition().attr('height',(pHeight+delta*2)*curSame.length+delta*2).attr('width',pWidth+delta*4).duration(250);

    for(i=0;i<curSame.length;i++) {
      svg.append('svg:image')
          .attr('y',yy).attr('x',xx)
          .attr('class','popup')
          .attr('width',sSize).attr('height',sSize)
          //.attr('xlink:href',function(d){ return "http://graph.facebook.com/"+d.id+"/picture"})
          .attr('xlink:href',fr[curSame[i]].picSrc)
          .transition().attr('height',sSize*2).attr('y',yy+i*(sSize+delta)*2).attr('width',sSize*2).duration(250);

      pText=svg.append('text').attr('class','popup')
          .attr('fill-opacity',0)
          .attr('fill','#fff');
      pText.append('tspan').attr('y',tHeight+yy+i*(sSize+delta)*2).attr('x',sSize*2+2*tMargin+xx)
          .text(function(){return fr[curSame[i]].name}); 
      pText.append('tspan').attr('y',2*tHeight+yy+i*(sSize+delta)*2).attr('x',sSize*2+2*tMargin+xx)
          .text(function(){return (fr[curSame[i]].fAge ? fr[curSame[i]].fAge : '')+(fr[curSame[i]].birthday ? ' ('+fr[curSame[i]].birthday+')' : '')});
      pText.transition().attr('fill-opacity',1).duration(250)
    };

    svg.append('rect').attr('class','popup').attr('stroke-width',0)
        .attr('y',yy-delta*2).attr('x',xx-delta*2)
        .attr('fill','#444').attr('fill-opacity',0)
        .attr('height',(pHeight+delta*2)*curSame.length+delta*2).attr('width',(sSize+delta)*2+delta*2)
        .style('cursor','pointer')
        .on('click',function(){
            iii=Math.floor((d3.mouse(this)[1]-d3.select(this).attr('y')-delta*2)/((sSize+delta)*2));
            //console.log(iii,curSame[iii]);
            d4.OpenInNewTab("//facebook.com/profile.php?id="+fr[curSame[iii]].id);
          })
        .on('mouseout',function(){
            d3.select(this).style('cursor',null)
            d3.selectAll('.popup').remove();
          });
}

function changePic(){
  if (isChangePic) {
    key=null;
    if (curMode!='heart') {
      kGender=modeKeys[curMode].kGender;
      kMode=modeKeys[curMode].kMode;
      if (scale[kMode].x>1) {
        while (fr[i=Math.floor(Math.random()*(fr.length-scale[kMode].x))][kMode]['onTop'+kGender]) ;
        //console.log(i);
          //console.log(i, fr[i]['same'+key]);
        if (fr[i].gender||kGender=='All') {
          if ((curSame=fr[i][kMode]['same'+kGender]).length>1) {
            for (ii=0;ii<curSame.length;ii++) fr[curSame[ii]][kMode]['onTop'+kGender]=false;
            fr[i][kMode]['onTop'+kGender]=true;
            d3.select($('#'+fr[i].id)[0]).style('opacity',0)
              .each(function(){this.parentNode.parentNode.appendChild(this.parentNode)})
              .transition().style('opacity',1).duration(dur*2);
            //d3.select(picOut[0]).style('opacity',1).transition().style('opacity',0).duration(dur).each(function(){
            //}).style('opacity',1);   d3.timer(function, [delay, [time]])
          }
        }
      }
    } else {
        i=Math.floor(Math.random()*(fr.length-scale.ages.x));
        d3.select(pic=$('#'+fr[i].id)[0]).transition().style('opacity',0).duration(dur*2);
        setTimeout(d4.up(pic.parentNode),dur*2);
        setTimeout(function(){
            pic.parentNode.parentNode.appendChild(pic.parentNode);
            d3.select(pic).transition().style('opacity',1).duration(dur*2);
          },dur*2);
    }
  }
  setTimeout(changePic,50);
}

function movePics(mode,durat){
    isChangePic=false;
    svg.selectAll('.pic')
        .transition()
        .attr('x',function(d){ return d.x[mode]; })
        .attr('y',function(d){ return d.y[mode]; })
        .style('opacity',1)
        .duration(durat ? durat : dur);    
    setTimeout(function(){isChangePic=true},durat ? durat : dur);
}

function boxAll(){
    svg.transition().attr('height',height).attr('width',width).duration(dur); 
    d4.hideOp('.'+curMode).transition().remove().duration(dur);
    d4.hideOp('#yourAge');
    movePics(curMode='boxAll');    
    d4.text(svg, modeTexts[curMode], tMargin, tHeight, 'title '+curMode,'','',1);
    scaleLegenda();
    //d4.text(svg,num.noAge.all+' friends hide their age ('+num.noAgeP+'% of total '+num.all+' friends)',-tMargin*2+width, (num.ageGroups-1)*(sSize+delta)+tHeight-tMargin/2-4, 'labels light '+curMode, '', 'end',1);
}

function boxFM(){
    svg.transition().attr('height',height).attr('width',width).duration(dur); 
    d4.hideOp('.'+curMode).transition().remove().duration(dur);
    d4.hideOp('#yourAge');
    movePics(curMode='boxFM');
    d4.text(svg, modeTexts[curMode], tMargin, tHeight, 'title '+curMode,'','',1);
    scaleLegenda();
    //d4.text(svg,num.noAge.all+' friends hide their age ('+num.noAgeP+'% of total '+num.all+' friends)',-tMargin*2+width, (num.ageGroups-1)*(sSize+delta)+tHeight-tMargin/2-4, 'labels light '+curMode, '', 'end',1);
}

function showAll(){
    svg.transition().attr('height',height).attr('width',width).duration(dur); 
    d4.hideOp('.'+curMode).transition().remove().duration(dur);
    movePics(curMode='agesAll');
    d4.text(svg, modeTexts[curMode], tMargin, tHeight, 'title '+curMode,'','',1);
    scaleLegenda();
    d4.showOp('#yourAge');
    svg.select('#axis').selectAll('g').data(ages).enter().append('text').attr('class','axis '+curMode)
        .style('text-anchor','middle')
        .style('font-weight',function(d){
            return d.me || d.low || d.high ? 'bold' : 'normal'
        })
        .text(function(d){ return d.text; })
        .attr('x',(sSize+delta)/2+labelWidth/2+margin.x.agesAll)
        .attr('y',function(d){ 
            if (d.low) margs=0;
            else if (d.high||d.noAge) margs=lowHighMargin*isLowInterval+lowHighMargin*isHighInterval
            else margs=lowHighMargin*isLowInterval;
            return margin.y+d.n*(sSize+delta)+tHeightAxis+margs; 
          })
        .style('fill-opacity',0)
        .transition()
        .style('fill-opacity',1)
        .duration(dur);
    if (you.fAge) {
        d4.text(svg, num.max.all+' friends the same age', -tMargin*2+width, margin.y+meY+tHeight-tMargin/2-1, 'labels '+curMode, '', 'end',1);
        d4.text(svg, num.older.all+' older ('+num.older.allP+'%)', -tMargin*2+width, margin.y+meY+tHeight-tMargin/2-1+(sSize+delta), 'labels light '+curMode, '', 'end',1);
        d4.text(svg, num.younger.all+' younger ('+num.younger.allP+'%)', -tMargin*2+width, margin.y+meY+tHeight-tMargin/2-1-(sSize+delta), 'labels light '+curMode, '', 'end',1);
      }
    d4.text(svg,num.noAge.all+' friends hide their age ('+num.noAgeP+'% of total '+num.all+' friends)',-tMargin*2+width, margin.y+(num.ageGroups)*(sSize+delta)+lowHighMargin*isLowInterval+lowHighMargin*isHighInterval+tHeight-tMargin/2-4, 'labels light '+curMode, '', 'end',1);
}

function showFM(){
    svg.transition().attr('height',height).attr('width',width).duration(dur); 
    d4.hideOp('.'+curMode).transition().remove().duration(dur);
    movePics(curMode='agesFM');
    d4.text(svg, modeTexts[curMode], tMargin, tHeight, 'title '+curMode,'','',1);
    scaleLegenda();
    d4.showOp('#yourAge');
    svg.select('#axis').selectAll('g').data(ages).enter().append('text').attr('class','axis '+curMode)
        .style('text-anchor','middle')
        .style('font-weight',function(d){
            return d.me || d.low || d.high ? 'bold' : 'normal'
        })
        .text(function(d){ return d.text; })
        .attr('x',margin.x.agesFM+(0.5+Math.floor(num.folded.max.f/scale.ages.x||num.max.f))*(sSize+delta)+labelWidth/2)
        .attr('y',function(d){ 
            if (d.low) margs=0;
            else if (d.high||d.noAge) margs=lowHighMargin*isLowInterval+lowHighMargin*isHighInterval
            else margs=lowHighMargin*isLowInterval;
            return margin.y+d.n*(sSize+delta)+tHeightAxis+margs; 
          })
        .style('fill-opacity',0)
        .transition()
        .style('fill-opacity',1)
        .duration(dur);
    if (you.fAge) {
        d4.text(svg, num.me.f+' girls the same age', tMargin, margin.y+meY+tHeight-tMargin/2-1, 'labels '+curMode,'','',1);   
        d4.text(svg, num.older.f+' older ('+num.older.fP+'%)', tMargin, margin.y+meY+tHeight-tMargin/2-1+(sSize+delta), 'labels light '+curMode, '', '',1);
        d4.text(svg, num.younger.f+' younger ('+num.younger.fP+'%)', tMargin, margin.y+meY+tHeight-tMargin/2-1-(sSize+delta), 'labels light '+curMode, '', '',1);
        d4.text(svg, num.me.m+' boys the same age', -tMargin*2+width, margin.y+meY+tHeight-tMargin/2-1, 'labels '+curMode, '', 'right',1)
        d4.text(svg, num.older.m+' older ('+num.older.mP+'%)', -tMargin*2+width, margin.y+meY+tHeight-tMargin/2-1+(sSize+delta), 'labels light '+curMode, '', 'end',1);
        d4.text(svg, num.younger.m+' younger ('+num.younger.mP+'%)', -tMargin*2+width, margin.y+meY+tHeight-tMargin/2-1-(sSize+delta), 'labels light '+curMode, '', 'end',1);
    } 
    d4.text(svg,num.noAge.m+' boys hide their age ('+num.noAge.mP+'% of total '+(num.noAge.m+num.m)+' boys)',-tMargin*2+width, margin.y+(num.ageGroups)*(sSize+delta)+lowHighMargin*isLowInterval+lowHighMargin*isHighInterval+tHeight-tMargin/2-4, 'labels light '+curMode, '', 'end',1);
    d4.text(svg,num.noAge.f+' girls hide their age ('+num.noAge.fP+'% of total '+(num.noAge.f+num.f)+' girls)',tMargin, margin.y+(num.ageGroups)*(sSize+delta)+lowHighMargin*isLowInterval+lowHighMargin*isHighInterval+tHeight-tMargin/2-4, 'labels light '+curMode, '', '',1);             
}

function randomCalc(){
  heartWidth=fr.length/2+100;
  if (heartWidth<200) heartWidth=200;
  if (heartWidth>500) heartWidth=500;
  if (heartWidth>width*0.9) heartWidth=Math.floor(width*0.9);
  if (heartWidth>height*0.9) heartWidth=Math.floor(height*0.9);
  heightH=Math.floor(heartWidth/0.9);  
  if (width-heightH > 300) widthH=heightH+300 
    else widthH=width-heightH;
  var hW=100,  hH=92;
  var paper = Raphael('heart',0, 0, hW, hH);
  d3.select('heart').style('display','none')
  var heart=paper.path(heartString);
  for (i=0;i<fr.length;i++) {
    for(isOk=false;!isOk;){
      x=Math.random()*hW;
      y=Math.random()*hH;
      isOk=heart.isPointInside(x,y);
    }
    fr[i].x.heart=(x-hW/2)*(heartWidth/hW)-sSize/2+widthH/2;
    fr[i].y.heart=(y-hW/2)*(heartWidth/hW)-sSize/2+heightH/2;
  }
  paper.remove();   
  return true;     
}

function showHeart(){
  d4.hideOp('#yourAge');
  d4.hideOp('.'+curMode).transition().remove().duration(dur);
  movePics(curMode='heart',2000);
     
  svg.transition().attr('height',heightH).attr('width',widthH).duration(2000); 

  setTimeout(randomCalc,2000);
}

function post2fbModal(){  

  function op2disp(el){
    d3.selectAll(el).style('display',function(){
      //console.log(d3.select(this).style('fill-opacity'),'0');
      if (d3.select(this).style('fill-opacity')==='0') return 'none'
        else d3.select(this).style('fill-opacity',null);
    });
  }
  function disp2op(el){
    d3.selectAll(el).style('display',function(){
      if (d3.select(this).style('fill-opacity')==='0') return null
        else d3.select(this).style('fill-opacity',1);
    })
  }

  op2disp('rect');
  op2disp('text');

  //d3.selectAll('rect').style('fill-opacity',null);
  //d3.selectAll('text').style('fill-opacity',null);
  curHeight=parseInt(svg.attr('height').split('px'));
  curWidth=parseInt(svg.attr('width').split('px'));
  console.log(curWidth,curHeight);
  var canvas=d4.svg2canvas('svg','canvas',curWidth/shareScale,curHeight/shareScale);
  context = canvas.getContext('2d');
  console.log(canvas,context);

  fr.forEach(function(d){
    base_image = new Image();
    base_image.src = d.picSrc;
    if (base_image.src) 
      context.drawImage(base_image, d.x[curMode]/shareScale, d.y[curMode]/shareScale,sSize/shareScale,sSize/shareScale);

  })
  console.log(base_image);
  blob = d4.canvas2png(canvas);
  console.log(blob); 

  //$('.modal-dialog').css({width:width/shareScale+margins*2});
  //$('#sharePic').width(width/shareScale);
  //leftMargin=$('#myModal').modal().find('.modal-dialog').css('margin').split('px')
  $('#myModal').modal().find('.modal-dialog').css({
                                  width:Math.max(curWidth/shareScale,width/2)+margins*2,
                                  height:curHeight/shareScale+margins*2
                                });

  $('#shareClick').click(function(){
    $('#myModal').modal('hide');
    fbPostPerm();
    
  });

  disp2op('rect');
  disp2op('text');
}

function post2fb(){
  var fd = new FormData();
  fd.append("access_token", authToken);
  fd.append("source", blob);
  fd.append("message", shareString);
      $.ajax({
          url: "https://graph.facebook.com/me/photos?access_token=" + authToken,
          type: "POST",
          data: fd,
          processData: false,
          contentType: false,
          cache: false,
          success: function (data) {
              console.log("success ", data);
              $(".shared").alert();
              d4.show('.shared');
              d3.select('#postedURL').attr('href',fbPostedURL+data.id)
          },
          error: function (shr, status, data) {
              console.log("error " + data + " Status " + shr.status);
          },
          complete: function () {
              console.log("Posted to facebook");
          }
      });
}

// Saving data during testing
function postDataAges(postPicURL) {
 var frAnon=[];
  fr.forEach(function(d){
    if (d.itsme) frAnon.push({'g':d.gender,'bd':d.birthday,'me':true})
    else frAnon.push({'g':d.gender,'bd':d.birthday})
  });
  if (!isDataSent) {
    $.ajax({
        type: "POST",
        url: statURL,
        // The key needs to match your method's input parameter (case-sensitive).
        data: JSON.stringify({ Img: postPicURL, Friends: frAnon }),
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        success: function(data){
          isDataSent = true; 
          console.log('data ok',data);},
        failure: function(errMsg) {
            console.log(errMsg);
        }
    });
    isDataSent = true;
  }
};

function postData(){
   //console.log(frAnon);

   // ---------------------------------------------------------------------------------------
   // TO DO http://stackoverflow.com/questions/7466974/posting-images-to-facebook-wall-js-sdk
   // ---------------------------------------------------------------------------------------

    postDataAges('0');
    $.ajax({
        // http://stackoverflow.com/questions/17805456/upload-a-canvas-image-to-imgur-api-v3-with-javascript
        // Saving picture during testing
        url: 'https://api.imgur.com/3/image',
        type: 'post',
        headers: {
            Authorization: 'Client-ID 2045a7bf3fc42f4'
        },
        data: {
            image: canvas.toDataURL().split(',')[1]
        },
        dataType: 'json',
        success: function(response) {
            if(response.success) {
                isDataSent=false;
                postDataAges(response.data.link);
                //window.location = response.data.link;
            }
        }
    });    
}

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-46761739-1', 'vritti.ru');
  ga('send', 'pageview');

</script></body></html>